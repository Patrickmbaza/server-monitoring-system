name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Required environment variables from your screenshot
  PORT: 8080
  TIMEZONE: Africa/Lagos
  # These will be overridden by secrets in deploy job
  TWILIO_ACCOUNT_SID: ""
  TWILIO_AUTH_TOKEN: ""
  TWILIO_WHATSAPP_NUMBER: ""
  ADMIN_WHATSAPP_NUMBERS: ""
  USER_WHATSAPP_NUMBERS: ""
  TEAMS_ADMIN_WEBHOOK: ""

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

    - name: Install R dependencies
      run: |
        R -e "install.packages(c('renv', 'testthat', 'httr', 'jsonlite'))"
        if [ -f "renv.lock" ]; then
          R -e "renv::restore()"
        fi

    - name: Run validation tests
      run: |
        # Check if required files exist
        if [ ! -f ".env.example" ]; then
          echo "âŒ .env.example file not found"
          exit 1
        fi
        echo "âœ… All required files present"
        
        # Test R script syntax
        R -e "source('app.R', echo = FALSE)" && echo "âœ… R syntax is valid"
        
        # Test environment variable loading (simulated)
        R -e "
          Sys.setenv(PORT = '8080')
          Sys.setenv(TIMEZONE = 'Africa/Lagos')
          cat('âœ… Environment variables setup test passed\n')
        "

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create .env file for Docker build
      run: |
        echo "# ========== REQUIRED ==========" > .env
        echo "PORT=${{ env.PORT }}" >> .env
        echo "TIMEZONE=${{ env.TIMEZONE }}" >> .env
        echo "" >> .env
        echo "# ========== TWILIO ==========" >> .env
        echo "TWILIO_ACCOUNT_SID=REPLACE_WITH_YOUR_SID" >> .env
        echo "TWILIO_AUTH_TOKEN=REPLACE_WITH_YOUR_TOKEN" >> .env
        echo "TWILIO_WHATSAPP_NUMBER=REPLACE_WITH_YOUR_NUMBER" >> .env
        echo "" >> .env
        echo "ADMIN_WHATSAPP_NUMBERS=REPLACE_WITH_ADMIN_NUMBERS" >> .env
        echo "USER_WHATSAPP_NUMBERS=REPLACE_WITH_USER_NUMBERS" >> .env
        echo "" >> .env
        echo "# ========== OPTIONAL ==========" >> .env
        echo "TEAMS_ADMIN_WEBHOOK=" >> .env

    - name: Create short SHA variable
      id: vars
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          crimson02/server-monitoring:latest
          crimson02/server-monitoring:${{ steps.vars.outputs.short_sha }}
        build-args: |
          PORT=${{ env.PORT }}
          TIMEZONE=${{ env.TIMEZONE }}
        cache-from: type=registry,ref=crimson02/server-monitoring:latest
        cache-to: type=inline

  deploy:
    name: Deploy and Notify
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    env:
      # Override with actual secrets
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      TWILIO_WHATSAPP_NUMBER: ${{ secrets.TWILIO_WHATSAPP_NUMBER }}
      ADMIN_WHATSAPP_NUMBERS: ${{ secrets.ADMIN_WHATSAPP_NUMBERS }}
      USER_WHATSAPP_NUMBERS: ${{ secrets.USER_WHATSAPP_NUMBERS }}
      TEAMS_ADMIN_WEBHOOK: ${{ secrets.TEAMS_ADMIN_WEBHOOK }}
    
    steps:
    - name: Create short SHA variable
      id: vars
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

    - name: Deploy to server (SSH example)
      if: env.TWILIO_ACCOUNT_SID != '' && env.TWILIO_AUTH_TOKEN != ''
      run: |
        echo "ğŸš€ Deployment would happen here..."
        echo "ğŸ“± Sending notifications to configured numbers"
        
        # Simulate sending deployment notification
        echo "ğŸ“¤ Sending WhatsApp notification to admins: $ADMIN_WHATSAPP_NUMBERS"
        echo "ğŸ“¤ Sending WhatsApp notification to users: $USER_WHATSAPP_NUMBERS"
        
        if [ -n "$TEAMS_ADMIN_WEBHOOK" ]; then
          echo "ğŸ“¤ Sending Teams notification via webhook"
        fi

    - name: Send deployment success notification
      if: success()
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸ“¦ Image: crimson02/server-monitoring:${{ steps.vars.outputs.short_sha }}"
        echo "ğŸŒ Port: ${{ env.PORT }}"
        echo "ğŸ•’ Timezone: ${{ env.TIMEZONE }}"

    - name: Send deployment failure notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Please check the workflow logs for details"